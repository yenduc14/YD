<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ƒê·∫£ng vi√™n</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyANdA2964j0uJbt5M8VPP2pUWEG0n1qhUM",
      authDomain: "quanlydangvien-1db27.firebaseapp.com",
      databaseURL: "https://quanlydangvien-1db27-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "quanlydangvien-1db27",
      storageBucket: "quanlydangvien-1db27.appspot.com",
      messagingSenderId: "251110236629",
      appId: "1:251110236629:web:bed1efeaa0a0c22456dd5c",
      measurementId: "G-SGZK54K7NF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <style>
    body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 1000px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; }
    h2 { text-align: center; color: #007bff; }
    input, select, button { margin: 5px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .btn { background: #007bff; color: white; cursor: pointer; border: none; }
    .btn:hover { background: #0056b3; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #007bff; color: white; }
    #logoutBtn { float: right; background: red; }
    .action-btn { background: #28a745; color: white; border: none; padding: 5px; margin: 2px; border-radius: 4px; cursor: pointer; }
    .delete-btn { background: red; }
  </style>
</head>
<body>

<!-- Ti√™u ƒë·ªÅ + C·ªù ƒê·∫£ng -->
<div style="display: flex; justify-content: center; align-items: center; position: relative;">
  <img src="codang.png" style="position: absolute; right: 20px; top: 0; height: 80px; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
  <div style="text-align: center; color: #007bff;">
    <h1 style="margin-bottom: 0;">ƒê·∫¢NG C·ªòNG S·∫¢N VI·ªÜT NAM</h1>
    <h2 style="margin-top: 5px;">ƒê·∫¢NG B·ªò PH∆Ø·ªúNG Y√äN ƒê·ª®C</h2>
  </div>
</div>

<div class="container">
  <div id="loginSection">
    <h2>ƒêƒÉng nh·∫≠p</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="M·∫≠t kh·∫©u">
    <button class="btn" onclick="login()">ƒêƒÉng nh·∫≠p</button>
  </div>

  <div id="mainSection" class="hidden">
    <h2>Danh s√°ch Chi b·ªô</h2>
    <button class="btn" id="logoutBtn" onclick="logout()">ƒêƒÉng xu·∫•t</button><br><br>
    <input id="newChiBo" placeholder="T√™n chi b·ªô m·ªõi">
    <button class="btn" onclick="addChiBo()">‚ûï Th√™m Chi b·ªô</button>
    <ul id="chiBoList"></ul>
  </div>

  <div id="chiBoDetail" class="hidden">
    <h2 id="chiBoTitle"></h2>
    <button class="btn" onclick="backToList()">‚Üê Quay l·∫°i</button>
    <input id="searchInput" placeholder="üîç T√¨m ki·∫øm..." oninput="renderTable()">
    <table>
      <thead>
        <tr>
          <th>STT</th><th>H·ªç v√† t√™n</th><th>Gi·ªõi t√≠nh</th><th>Ng√†y sinh</th>
          <th>Ng√†y v√†o ƒê·∫£ng</th><th>Ch√≠nh th·ª©c</th><th>Tu·ªïi ƒê·∫£ng</th>
          <th>Huy hi·ªáu</th><th>Ghi ch√∫</th><th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="dvTableBody"></tbody>
    </table>
    <button class="btn" onclick="addDangVien()">‚ûï Th√™m ƒê·∫£ng vi√™n</button>
  </div>
</div>

<script>
const USERS_KEY = 'users';
let currentUser = null;
let currentChiBo = null;

const defaultUsers = [
  { email: 'admin@gmail.com', password: 'admin123', role: 'admin' },
  { email: 'user@gmail.com', password: 'user123', role: 'user' }
];

window.onload = () => {
  if (!localStorage.getItem(USERS_KEY)) {
    localStorage.setItem(USERS_KEY, JSON.stringify(defaultUsers));
  }
};

function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  const found = users.find(u => u.email === email && u.password === password);
  if (found) {
    currentUser = found;
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("mainSection").classList.remove("hidden");
    renderChiBoList();
  } else {
    alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u.");
  }
}

function logout() {
  currentUser = null;
  currentChiBo = null;
  document.getElementById("mainSection").classList.add("hidden");
  document.getElementById("chiBoDetail").classList.add("hidden");
  document.getElementById("loginSection").classList.remove("hidden");
}

function addChiBo() {
  const name = document.getElementById("newChiBo").value.trim();
  if (!name) return alert("Nh·∫≠p t√™n chi b·ªô.");
  db.ref("chibo/" + name).set([]);
  renderChiBoList();
  document.getElementById("newChiBo").value = '';
}

function deleteChiBo(name) {
  if (!confirm(`X√≥a chi b·ªô "${name}"?`)) return;
  db.ref("chibo/" + name).remove();
  renderChiBoList();
}

function renderChiBoList() {
  const ul = document.getElementById("chiBoList");
  ul.innerHTML = '';
  db.ref("chibo").once('value').then(snapshot => {
    const data = snapshot.val() || {};
    for (let name in data) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${name}</strong> <button class='action-btn' onclick='openChiBo("${name}")'>M·ªü</button> ${currentUser?.role === 'admin' ? `<button class='action-btn delete-btn' onclick='deleteChiBo("${name}")'>X√≥a</button>` : ''}`;
      ul.appendChild(li);
    }
  });
}

function openChiBo(name) {
  currentChiBo = name;
  document.getElementById("mainSection").classList.add("hidden");
  document.getElementById("chiBoDetail").classList.remove("hidden");
  document.getElementById("chiBoTitle").innerText = `Chi b·ªô: ${name}`;
  renderTable();
}

function backToList() {
  document.getElementById("chiBoDetail").classList.add("hidden");
  document.getElementById("mainSection").classList.remove("hidden");
}

function renderTable() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const tbody = document.getElementById("dvTableBody");
  tbody.innerHTML = '';
  db.ref("chibo/" + currentChiBo).once('value').then(snapshot => {
    const data = snapshot.val() || [];
    data.forEach((dv, i) => {
      if (!dv.name?.toLowerCase().includes(keyword)) return;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${dv.name}</td>
        <td>${dv.gender}</td>
        <td>${dv.dob}</td>
        <td>${dv.ngayVaoDang}</td>
        <td>${dv.chinhThuc}</td>
        <td>${calcAge(dv.ngayVaoDang)}</td>
        <td>${dv.huyHieu || ''}</td>
        <td>${dv.note || ''}</td>
        <td>${currentUser?.role === 'admin' ? `<button class='action-btn' onclick='editDV(${i})'>S·ª≠a</button><button class='action-btn delete-btn' onclick='deleteDV(${i})'>X√≥a</button>` : ''}</td>`;
      tbody.appendChild(tr);
    });
  });
}

function calcAge(dateStr) {
  if (!dateStr) return '';
  const [d, m, y] = dateStr.split('/').map(Number);
  if (!d || !m || !y) return '';
  const from = new Date(y, m - 1, d);
  const now = new Date();
  let years = now.getFullYear() - from.getFullYear();
  let months = now.getMonth() - from.getMonth();
  let days = now.getDate() - from.getDate();
  if (days < 0) { days += 30; months--; }
  if (months < 0) { months += 12; years--; }
  return `${years} nƒÉm ${months} th√°ng ${days} ng√†y`;
}
</script>

</body>
</html>
