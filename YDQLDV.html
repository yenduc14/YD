<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quáº£n lÃ½ Äáº£ng viÃªn</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 1000px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; }
    h2 { text-align: center; color: #007bff; }
    input, select, button { margin: 5px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .btn { background: #007bff; color: white; cursor: pointer; border: none; }
    .btn:hover { background: #0056b3; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #007bff; color: white; }
    #logoutBtn { float: right; background: red; }
    .action-btn { background: #28a745; color: white; border: none; padding: 5px; margin: 2px; border-radius: 4px; cursor: pointer; }
    .delete-btn { background: red; }
  </style>
</head>
<body>
<div style="display: flex; justify-content: center; align-items: center; position: relative;">
  <img src="codang.png" style="position: absolute; right: 20px; top: 0; height: 80px; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);" />
  <div style="text-align: center; color: #007bff;">
    <h1 style="margin-bottom: 0;">Äáº¢NG Cá»˜NG Sáº¢N VIá»†T NAM</h1>
    <h2 style="margin-top: 5px;">Äáº¢NG Bá»˜ PHÆ¯á»œNG YÃŠN Äá»¨C</h2>
  </div>
</div>

<div class="container">
  <div id="loginSection">
    <h2>ÄÄƒng nháº­p</h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Máº­t kháº©u" />
    <button class="btn" onclick="login()">ÄÄƒng nháº­p</button>
  </div>

  <div id="mainSection" class="hidden">
    <h2>Danh sÃ¡ch Chi bá»™</h2>
    <button class="btn" id="logoutBtn" onclick="logout()">ÄÄƒng xuáº¥t</button><br><br>
    <input id="newChiBo" placeholder="TÃªn chi bá»™ má»›i" />
    <button class="btn" onclick="addChiBo()">â• ThÃªm Chi bá»™</button>
    <ul id="chiBoList"></ul>
  </div>

  <div id="chiBoDetail" class="hidden">
    <h2 id="chiBoTitle"></h2>
    <button class="btn" onclick="backToList()">â† Quay láº¡i</button>
    <input id="searchInput" placeholder="ğŸ” TÃ¬m kiáº¿m..." oninput="renderTable()"/>
    <button class="btn" onclick="document.getElementById('excelFile').click()">ğŸ“¥ Nháº­p Excel</button>
    <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" />
    <button class="btn" onclick="exportExcel()">ğŸ“¤ Xuáº¥t Excel</button>
    <table>
      <thead>
        <tr>
          <th>STT</th><th>Há» vÃ  tÃªn</th><th>Giá»›i tÃ­nh</th><th>NgÃ y sinh</th>
          <th>NgÃ y vÃ o Äáº£ng</th><th>ChÃ­nh thá»©c</th><th>Tuá»•i Äáº£ng</th>
          <th>Huy hiá»‡u</th><th>Ghi chÃº</th><th>Thao tÃ¡c</th>
        </tr>
      </thead>
      <tbody id="dvTableBody"></tbody>
    </table>
    <button class="btn" onclick="addDangVien()">â• ThÃªm Äáº£ng viÃªn</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBm2sbTD9yOOoySCkTTw8dQbTx1JKvFX6E",
  authDomain: "quanlydangvien-856fe.firebaseapp.com",
  databaseURL: "https://quanlydangvien-856fe-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "quanlydangvien-856fe",
  storageBucket: "quanlydangvien-856fe.appspot.com",
  messagingSenderId: "610889754602",
  appId: "1:610889754602:web:089c480d64712707ec7493"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const USERS_KEY = 'users';
let currentUser = null;
let currentChiBo = null;

const defaultUsers = [
  { email: 'admin@gmail.com', password: 'admin123', role: 'admin' },
  { email: 'user@gmail.com', password: 'user123', role: 'user' }
];

window.onload = () => {
  if (!localStorage.getItem(USERS_KEY)) {
    localStorage.setItem(USERS_KEY, JSON.stringify(defaultUsers));
  }
};

function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  const found = users.find(u => u.email === email && u.password === password);
  if (found) {
    currentUser = found;
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("mainSection").classList.remove("hidden");
    renderChiBoList();
  } else {
    alert("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u.");
  }
}

function logout() {
  currentUser = null;
  currentChiBo = null;
  document.getElementById("mainSection").classList.add("hidden");
  document.getElementById("chiBoDetail").classList.add("hidden");
  document.getElementById("loginSection").classList.remove("hidden");
}

function renderChiBoList() {
  const ul = document.getElementById("chiBoList");
  ul.innerHTML = '';
  db.ref('chibo_data').once('value').then(snapshot => {
    let data = snapshot.val();
    if (Array.isArray(data)) {
      console.warn("Dá»¯ liá»‡u chi bá»™ khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng object. Äang reset láº¡i...");
      data = {};
      db.ref('chibo_data').set(data);
    }
    for (let name in data) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${name}</strong> <button class="action-btn" onclick="openChiBo('${name}')">Má»Ÿ</button> ${currentUser?.role === 'admin' ? `<button class="action-btn delete-btn" onclick="deleteChiBo('${name}')">XoÃ¡</button>` : ''}`;
      ul.appendChild(li);
    }
  });
}

 function addChiBo() {
      const name = document.getElementById("newChiBo").value.trim();
      if (!name) {
        alert("Vui lÃ²ng nháº­p tÃªn chi bá»™.");
        return;
      }

      const ref = db.ref("chibo_data/" + name);
      ref.once("value")
        .then(snapshot => {
          if (snapshot.exists()) {
            alert("Chi bá»™ Ä‘Ã£ tá»“n táº¡i.");
          } else {
            ref.set({ createdAt: new Date().toISOString() })
              .then(() => {
                document.getElementById("newChiBo").value = "";
                renderChiBoList();
              })
              .catch(err => {
                console.error("Lá»—i khi thÃªm chi bá»™:", err);
                alert("Lá»—i khi thÃªm chi bá»™. Xem console.");
              });
          }
        })
        .catch(err => {
          console.error("Lá»—i kiá»ƒm tra chi bá»™:", err);
          alert("Lá»—i kiá»ƒm tra chi bá»™. Xem console.");
        });
    }

function deleteChiBo(name) {
  if (!confirm(`XÃ³a chi bá»™ "${name}"?`)) return;
  db.ref(`chibo_data/${name}`).remove().then(renderChiBoList);
}

function openChiBo(name) {
  currentChiBo = name;
  document.getElementById("mainSection").classList.add("hidden");
  document.getElementById("chiBoDetail").classList.remove("hidden");
  document.getElementById("chiBoTitle").innerText = "Chi bá»™: " + name;
  renderTable();
}

function backToList() {
  currentChiBo = null;
  document.getElementById("chiBoDetail").classList.add("hidden");
  document.getElementById("mainSection").classList.remove("hidden");
}

function renderTable() {
  const tbody = document.getElementById("dvTableBody");
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    tbody.innerHTML = '';
    if (!Array.isArray(list)) return;
    list.forEach((dv, index) => {
      if (!dv.name?.toLowerCase().includes(keyword)) return;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index + 1}</td><td>${dv.name}</td><td>${dv.gender}</td><td>${dv.dob}</td>
        <td>${dv.ngayVaoDang}</td><td>${dv.chinhThuc}</td><td>${calcAge(dv.ngayVaoDang)}</td>
        <td>${dv.huyHieu || ''}</td><td>${dv.note || ''}</td>
        <td>
          <button class="action-btn" onclick="editDV(${index})">âœï¸</button>
          <button class="action-btn delete-btn" onclick="deleteDV(${index})">ğŸ—‘ï¸</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}

function addDangVien() {
  const name = prompt("TÃªn Ä‘áº£ng viÃªn:");
  if (!name) return;
  const newDV = { name, gender: '', dob: '', ngayVaoDang: '', chinhThuc: '', huyHieu: '', note: '' };
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    list.push(newDV);
    db.ref(`chibo_data/${currentChiBo}`).set(list).then(renderTable);
  });
}

function editDV(index) {
  const newNote = prompt("Cáº­p nháº­t ghi chÃº:");
  if (newNote === null) return;
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    list[index].note = newNote;
    db.ref(`chibo_data/${currentChiBo}`).set(list).then(renderTable);
  });
}

function deleteDV(index) {
  if (!confirm("XoÃ¡ Ä‘áº£ng viÃªn nÃ y?")) return;
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    list.splice(index, 1);
    db.ref(`chibo_data/${currentChiBo}`).set(list).then(renderTable);
  });
}

function calcAge(dateStr) {
  try {
    const parts = String(dateStr).split("/");
    if (parts.length !== 3) return '';
    const birthDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    const today = new Date();

    let years = today.getFullYear() - birthDate.getFullYear();
    let months = today.getMonth() - birthDate.getMonth();
    let days = today.getDate() - birthDate.getDate();

    if (days < 0) {
      months -= 1;
      days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
    }
    if (months < 0) {
      years -= 1;
      months += 12;
    }

    return `${years} nÄƒm ${months} thÃ¡ng ${days} ngÃ y`;
  } catch (err) {
    console.error("Lá»—i tÃ­nh tuá»•i Äáº£ng:", err);
    return '';
  }
}

function exportExcel() {
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    const rows = [["STT", "Há» vÃ  tÃªn", "Giá»›i tÃ­nh", "NgÃ y sinh", "NgÃ y vÃ o Äáº£ng", "ChÃ­nh thá»©c", "Tuá»•i Äáº£ng", "Huy hiá»‡u", "Ghi chÃº"]];
    
    list.forEach((dv, index) => {
      rows.push([
        index + 1,
        dv.name || '', dv.gender || '', dv.dob || '', dv.ngayVaoDang || '',
        dv.chinhThuc || '', dv.tuoiDang || '', dv.huyHieu || '', dv.note || ''
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Danh sÃ¡ch");
    XLSX.writeFile(wb, `${currentChiBo}_dangvien.xlsx`);
  });
}

document.getElementById("excelFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return alert("KhÃ´ng cÃ³ file nÃ o Ä‘Æ°á»£c chá»n");
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});  // Äáº£m báº£o khÃ´ng cÃ³ giÃ¡ trá»‹ null

      // Duyá»‡t qua tá»«ng dÃ²ng dá»¯ liá»‡u tá»« Excel vÃ  chuyá»ƒn Ä‘á»•i
      const convert = rows.slice(1).map(r => ({
        name: r[0] || '',                // Há» vÃ  tÃªn
        gender: r[1] || '',              // Giá»›i tÃ­nh (Nam/Ná»¯)
        dob: r[2] || '',                // NgÃ y sinh
        ngayVaoDang: r[3] || '',        // NgÃ y vÃ o Äáº£ng
        chinhThuc: r[4] || '',          // Cháº¿ Ä‘á»™ chÃ­nh thá»©c
        tuoiDang: r[5] || '',           // Tuá»•i Äáº£ng
        huyHieu: r[6] || '',            // Huy hiá»‡u
        note: r[7] || ''                // Ghi chÃº
      }));

      // LÆ°u dá»¯ liá»‡u vÃ o Firebase
      db.ref(`chibo_data/${currentChiBo}`).set(convert).then(renderTable);

    } catch (err) {
      console.error("Lá»—i khi Ä‘á»c file Excel:", err);
      alert("Lá»—i khi Ä‘á»c file Excel. Vui lÃ²ng kiá»ƒm tra Ä‘á»‹nh dáº¡ng.");
    }
  };
  
  reader.readAsArrayBuffer(file);
});

</script>
</body>
</html>
