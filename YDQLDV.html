<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý Đảng viên</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 1000px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; }
    h2 { text-align: center; color: #007bff; }
    input, select, button { margin: 5px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .btn { background: #007bff; color: white; cursor: pointer; border: none; }
    .btn:hover { background: #0056b3; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #007bff; color: white; }
    #logoutBtn { float: right; background: red; }
    .action-btn { background: #28a745; color: white; border: none; padding: 5px; margin: 2px; border-radius: 4px; cursor: pointer; }
    .delete-btn { background: red; }
  </style>
</head>
<body>
<div style="display: flex; justify-content: center; align-items: center; position: relative;">
  <img src="codang.png" style="position: absolute; right: 20px; top: 0; height: 80px; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);" />
  <div style="text-align: center; color: #007bff;">
    <h1 style="margin-bottom: 0;">ĐẢNG CỘNG SẢN VIỆT NAM</h1>
    <h2 style="margin-top: 5px;">ĐẢNG BỘ PHƯỜNG YÊN ĐỨC</h2>
  </div>
</div>

<div class="container">
  <div id="loginSection">
    <h2>Đăng nhập</h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Mật khẩu" />
    <button class="btn" onclick="login()">Đăng nhập</button>
  </div>

  <div id="mainSection" class="hidden">
    <h2>Danh sách Chi bộ</h2>
    <button class="btn" id="logoutBtn" onclick="logout()">Đăng xuất</button><br><br>
    <input id="newChiBo" placeholder="Tên chi bộ mới" />
    <button class="btn" onclick="addChiBo()">➕ Thêm Chi bộ</button>
    <ul id="chiBoList"></ul>
  </div>

  <div id="chiBoDetail" class="hidden">
    <h2 id="chiBoTitle"></h2>
    <button class="btn" onclick="backToList()">← Quay lại</button>
    <input id="searchInput" placeholder="🔍 Tìm kiếm..." oninput="renderTable()"/>
    <button class="btn" onclick="document.getElementById('excelFile').click()">📥 Nhập Excel</button>
    <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" />
    <button class="btn" onclick="exportExcel()">📤 Xuất Excel</button>
    <table>
      <thead>
        <tr>
          <th>STT</th><th>Họ và tên</th><th>Giới tính</th><th>Ngày sinh</th>
          <th>Ngày vào Đảng</th><th>Chính thức</th><th>Tuổi Đảng</th>
          <th>Huy hiệu</th><th>Ghi chú</th><th>Thao tác</th>
        </tr>
      </thead>
      <tbody id="dvTableBody"></tbody>
    </table>
    <button class="btn" onclick="addDangVien()">➕ Thêm Đảng viên</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBm2sbTD9yOOoySCkTTw8dQbTx1JKvFX6E",
  authDomain: "quanlydangvien-856fe.firebaseapp.com",
  databaseURL: "https://quanlydangvien-856fe-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "quanlydangvien-856fe",
  storageBucket: "quanlydangvien-856fe.appspot.com",
  messagingSenderId: "610889754602",
  appId: "1:610889754602:web:089c480d64712707ec7493"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const USERS_KEY = 'users';
let currentUser = null;
let currentChiBo = null;

const defaultUsers = [
  { email: 'admin@gmail.com', password: 'admin123', role: 'admin' },
  { email: 'user@gmail.com', password: 'user123', role: 'user' }
];

window.onload = () => {
  // Khởi tạo danh sách người dùng nếu chưa có
  if (!localStorage.getItem(USERS_KEY)) {
    localStorage.setItem(USERS_KEY, JSON.stringify(defaultUsers));
  }

  // KHÔNG kích hoạt Sortable ở đây, vì đã xử lý đúng quyền trong renderTable()
};

function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];

  const found = users.find(u => u.email === email && u.password === password);

  if (found) {
    currentUser = found;
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("mainSection").classList.remove("hidden");

    // Ẩn chức năng nếu là người dùng thường
    if (currentUser.role !== 'admin') {
      document.getElementById("newChiBo").style.display = "none";
      const addBtn = document.querySelector('button[onclick="addChiBo()"]');
      if (addBtn) addBtn.style.display = "none";
    }

    renderChiBoList();
  } else {
    alert("Sai tài khoản hoặc mật khẩu.");
  }
}

function logout() {
  currentUser = null;
  currentChiBo = null;
  document.getElementById("mainSection").classList.add("hidden");
  document.getElementById("chiBoDetail").classList.add("hidden");
  document.getElementById("loginSection").classList.remove("hidden");
}

function renderChiBoList() {
  const ul = document.getElementById("chiBoList");
  ul.innerHTML = '';
  db.ref('chibo_data').once('value').then(snapshot => {
    let data = snapshot.val();
    if (Array.isArray(data)) {
      console.warn("Dữ liệu chi bộ không đúng định dạng object. Đang reset lại...");
      data = {};
      db.ref('chibo_data').set(data);
    }
    for (let name in data) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${name}</strong> <button class="action-btn" onclick="openChiBo('${name}')">Mở</button> ${currentUser?.role === 'admin' ? `<button class="action-btn delete-btn" onclick="deleteChiBo('${name}')">Xoá</button>` : ''}`;
      ul.appendChild(li);
    }
  });
}

 function addChiBo() {
      const name = document.getElementById("newChiBo").value.trim();
      if (!name) {
        alert("Vui lòng nhập tên chi bộ.");
        return;
      }

      const ref = db.ref("chibo_data/" + name);
      ref.once("value")
        .then(snapshot => {
          if (snapshot.exists()) {
            alert("Chi bộ đã tồn tại.");
          } else {
            ref.set({ createdAt: new Date().toISOString() })
              .then(() => {
                document.getElementById("newChiBo").value = "";
                renderChiBoList();
              })
              .catch(err => {
                console.error("Lỗi khi thêm chi bộ:", err);
                alert("Lỗi khi thêm chi bộ. Xem console.");
              });
          }
        })
        .catch(err => {
          console.error("Lỗi kiểm tra chi bộ:", err);
          alert("Lỗi kiểm tra chi bộ. Xem console.");
        });
    }

function deleteChiBo(name) {
  if (!confirm(`Xóa chi bộ "${name}"?`)) return;
  db.ref(`chibo_data/${name}`).remove().then(renderChiBoList);
}

function openChiBo(name) {
  currentChiBo = name;
  document.getElementById("mainSection").classList.add("hidden");
  document.getElementById("chiBoDetail").classList.remove("hidden");
  document.getElementById("chiBoTitle").innerText = "Chi bộ: " + name;
if (currentUser.role !== 'admin') {
    document.getElementById("excelFile").style.display = "none";
    document.querySelector('button[onclick="exportExcel()"]')?.style.display = "none";
    document.querySelector('button[onclick="addDangVien()"]')?.style.display = "none";
  }
  renderTable();
}

function backToList() {
  currentChiBo = null;
  document.getElementById("chiBoDetail").classList.add("hidden");
  document.getElementById("mainSection").classList.remove("hidden");
}

function renderTable() {
  const tbody = document.getElementById("dvTableBody");
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    tbody.innerHTML = '';
    if (!Array.isArray(list)) return;
    list.forEach((dv, index) => {
      if (!dv.name?.toLowerCase().includes(keyword)) return;

      // Sử dụng hàm shouldHighlight để xác định nếu cần highlight
      const highlight = shouldHighlight(dv.ngayVaoDang);
      const nameCell = highlight ? `<span style="color:red; font-weight:bold;">${dv.name}</span>` : dv.name;
      const tuoiDangStr = calcAge(dv.ngayVaoDang);

      const tr = document.createElement("tr");
      if (highlight) {
        tr.style.color = "red"; // Áp dụng màu đỏ cho dòng khi tròn tuổi Đảng
      }

      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${nameCell}</td>
        <td>${dv.gender}</td>
        <td>${dv.dob}</td>
        <td>${dv.ngayVaoDang}</td>
        <td>${dv.chinhThuc}</td>
        <td>${tuoiDangStr}</td>
        <td>${dv.huyHieu || ''}</td>
        <td>${dv.note || ''}</td>
        <td>
         ${currentUser?.role === 'admin' ? `
            <button class="action-btn" onclick="editDV(${index})">✏️</button>
            <button class="action-btn delete-btn" onclick="deleteDV(${index})">🗑️</button>
          ` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Chỉ kích hoạt Sortable nếu là admin
    if (currentUser?.role === 'admin') {
      new Sortable(document.getElementById('dvTableBody'), {
        animation: 150,
        onEnd: function (evt) {
          const newList = [];
          document.querySelectorAll('#dvTableBody tr').forEach(tr => {
            const cells = tr.querySelectorAll('td');
            newList.push({
              name: cells[1].innerText,
              gender: cells[2].innerText,
              dob: cells[3].innerText,
              ngayVaoDang: cells[4].innerText,
              chinhThuc: cells[5].innerText,
              tuoiDang: cells[6].innerText,
              huyHieu: cells[7].innerText,
              note: cells[8].innerText
            });
          });
          db.ref(`chibo_data/${currentChiBo}`).set(newList).then(renderTable);
        }
      });

function addDangVien() {
  const name = prompt("Tên đảng viên:");
  if (name === null || name.trim() === "") return;

  const gender = prompt("Giới tính (Nam/Nữ):") || "";
  const dob = prompt("Ngày sinh (dd/mm/yyyy):") || "";
  const ngayVaoDang = prompt("Ngày vào Đảng (dd/mm/yyyy):") || "";
  const chinhThuc = prompt("Ngày chính thức (dd/mm/yyyy):") || "";
  const huyHieu = prompt("Huy hiệu:") || "";
  const note = prompt("Ghi chú:") || "";

  const newDV = {
    name: name.trim(),
    gender: gender.trim(),
    dob: dob.trim(),
    ngayVaoDang: ngayVaoDang.trim(),
    chinhThuc: chinhThuc.trim(),
    huyHieu: huyHieu.trim(),
    note: note.trim()
  };

  // Lấy danh sách đảng viên từ Firebase
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    list.push(newDV); // Thêm đảng viên mới vào danh sách

    // Cập nhật danh sách lên Firebase và render lại bảng
    db.ref(`chibo_data/${currentChiBo}`).set(list).then(renderTable);
  });
}

function editDV(index) {
  // Lấy dữ liệu chi bộ hiện tại
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    const dv = list[index];  // Đảng viên cần sửa

    // Tiến hành sửa thông tin đảng viên
    const name = prompt("Cập nhật tên đảng viên:", dv.name);
    const gender = prompt("Cập nhật giới tính:", dv.gender);
    const dob = prompt("Cập nhật ngày sinh:", dv.dob);
    const ngayVaoDang = prompt("Cập nhật ngày vào Đảng:", dv.ngayVaoDang);
    const huyHieu = prompt("Cập nhật huy hiệu:", dv.huyHieu);
    const note = prompt("Cập nhật ghi chú:", dv.note);

    // Kiểm tra điều kiện nhập liệu
    if (name != null && gender != null && dob != null && ngayVaoDang != null && huyHieu != null && note != null) {
      const updatedDV = {
        name: name || dv.name,
        gender: gender || dv.gender,
        dob: dob || dv.dob,
        ngayVaoDang: ngayVaoDang || dv.ngayVaoDang,
        huyHieu: huyHieu || dv.huyHieu,
        note: note || dv.note
      };

      // Cập nhật lại danh sách vào Firebase
      list[index] = updatedDV; // Cập nhật đảng viên
      db.ref(`chibo_data/${currentChiBo}`).set(list).then(renderTable); // Cập nhật Firebase và render lại bảng
    }
  });
}

function updateDVInDB(index, updatedDV) {
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    list[index] = updatedDV; // Cập nhật thông tin đảng viên
    db.ref(`chibo_data/${currentChiBo}`).set(list).then(renderTable); // Lưu lại và render bảng
  });
}

function getDVByIndex(index) {
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    return list[index];
  });
}

function deleteDV(index) {
  if (!confirm("Xoá đảng viên này?")) return;
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    list.splice(index, 1);
    db.ref(`chibo_data/${currentChiBo}`).set(list).then(renderTable);
  });
}

function calcAge(dateStr) {
  try {
    const parts = String(dateStr).split("/");
    if (parts.length !== 3) return '';
    const birthDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    const today = new Date();

    let years = today.getFullYear() - birthDate.getFullYear();
    let months = today.getMonth() - birthDate.getMonth();
    let days = today.getDate() - birthDate.getDate();

    if (days < 0) {
      months -= 1;
      days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
    }
    if (months < 0) {
      years -= 1;
      months += 12;
    }

    return `${years} năm ${months} tháng ${days} ngày`;
  } catch (err) {
    console.error("Lỗi tính tuổi Đảng:", err);
    return '';
  }
}
function shouldHighlight(ngayVaoDangStr) {
  const milestones = [30, 40, 45, 50, 55, 60, 65, 70];
  const leDates = [
    { day: 3, month: 2 },
    { day: 19, month: 5 },
    { day: 2, month: 9 },
    { day: 7, month: 11 }
  ];

  try {
    const parts = ngayVaoDangStr.split("/");
    if (parts.length !== 3) return false;

    const joinDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
    const now = new Date();

    for (const milestone of milestones) {
      const targetYear = joinDate.getFullYear() + milestone;

      for (const { day, month } of leDates) {
        const eventDate = new Date(targetYear, month - 1, day);
        const startAlert = new Date(eventDate);
        startAlert.setMonth(eventDate.getMonth() - 1); // Trước 1 tháng

        // Nếu trong khoảng từ 1 tháng trước đến đúng ngày lễ => báo đỏ
        if (now >= startAlert && now <= eventDate) {
          return true;
        }
      }
    }
  } catch (e) {
    console.error("Lỗi shouldHighlight:", e);
  }

  return false;
}

function exportExcel() {
  db.ref(`chibo_data/${currentChiBo}`).once('value').then(snapshot => {
    const list = snapshot.val() || [];
    const rows = [["STT", "Họ và tên", "Giới tính", "Ngày sinh", "Ngày vào Đảng", "Chính thức", "Tuổi Đảng", "Huy hiệu", "Ghi chú"]];
    
    list.forEach((dv, index) => {
      rows.push([
        index + 1,
        dv.name || '', dv.gender || '', dv.dob || '', dv.ngayVaoDang || '',
        dv.chinhThuc || '', dv.tuoiDang || '', dv.huyHieu || '', dv.note || ''
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Danh sách");
    XLSX.writeFile(wb, `${currentChiBo}_dangvien.xlsx`);
  });
}

document.getElementById("excelFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return alert("Không có file nào được chọn");
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});  // header:1 để giữ mảng dòng, defval để tránh undefined

      // Bỏ duy nhất dòng tiêu đề đầu tiên
      
function excelDateToString(serial) {
  if (typeof serial === 'number') {
    const utc_days = Math.floor(serial - 25569);  // Điều chỉnh giá trị 25569 cho chuẩn ngày Excel
    const utc_value = utc_days * 86400;  // Chuyển đổi thành giây
    const date_info = new Date(utc_value * 1000);  // Chuyển đổi thành đối tượng Date trong JavaScript
    const day = String(date_info.getDate()).padStart(2, '0');
    const month = String(date_info.getMonth() + 1).padStart(2, '0');
    const year = date_info.getFullYear();
    return `${day}/${month}/${year}`;  // Định dạng ngày theo kiểu dd/mm/yyyy
  } else if (typeof serial === 'string') {
    return serial.trim();  // Nếu đã là chuỗi, chỉ cần cắt bỏ khoảng trắng
  }
  return '';  // Trả về chuỗi rỗng nếu không phải kiểu số hoặc chuỗi
}

const convert = rows.slice(2).map(r => ({
  name: r[1] || '',
  gender: r[2]?.toLowerCase() === 'x' ? 'Nữ' : (r[2]?.toLowerCase() === 'y' ? 'Nam' : ''),
  dob: excelDateToString(r[3]) || '',  // Áp dụng excelDateToString cho 'dob'
  ngayVaoDang: excelDateToString(r[4]) || '',  // Áp dụng excelDateToString cho 'ngayVaoDang'
  chinhThuc: r[5] || '',
  tuoiDang: r[6] || '',
  huyHieu: r[7] || '',
  note: r[8] || ''
}));

      db.ref(`chibo_data/${currentChiBo}`).set(convert).then(renderTable);
    } catch (err) {
      console.error("Lỗi khi đọc file Excel:", err);
      alert("Lỗi khi đọc file Excel. Vui lòng kiểm tra định dạng.");
    }
  };
  reader.readAsArrayBuffer(file);
});

// Hàm kiểm tra và định dạng ngày sinh
function formatDate(date) {
  if (!date) return '';
  try {
    const parts = date.split('/');
    if (parts.length === 3) {
      const formattedDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
      return formattedDate.toLocaleDateString('vi-VN');  // Đảm bảo ngày được định dạng là dd/mm/yyyy
    }
    return '';
  } catch (err) {
    console.error("Lỗi định dạng ngày sinh:", err);
    return '';
  }
}

</script>
</body>
</html>
